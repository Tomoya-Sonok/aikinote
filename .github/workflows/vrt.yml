name: Visual Regression Test

on:
  pull_request:
    branches: [main]
    paths:
      - "frontend/**"
      - ".github/workflows/vrt.yml"

permissions:
  contents: read
  pull-requests: write
  pages: write
  id-token: write

jobs:
  screenshot-actual:
    name: PR „Éñ„É©„É≥„ÉÅ„ÅÆ„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊíÆÂΩ±
    runs-on: ubuntu-latest
    steps:
      - name: „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÔºàPR „Éñ„É©„É≥„ÉÅÔºâ
        uses: actions/checkout@v4

      - name: Node.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: pnpm „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: ‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
        run: pnpm install --frozen-lockfile

      - name: Playwright „Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Storybook „ÅÆ„Éì„É´„Éâ
        working-directory: frontend
        run: pnpm build-storybook

      - name: „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊíÆÂΩ±
        working-directory: frontend
        run: |
          python3 -m http.server 6006 --directory storybook-static &
          node scripts/capture-screenshots.mjs
        env:
          STORYBOOK_URL: http://localhost:6006
          SCREENSHOT_DIR: __screenshots__

      - name: „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-actual
          path: frontend/__screenshots__
          retention-days: 30

  screenshot-expected:
    name: main „Éñ„É©„É≥„ÉÅ„ÅÆ„Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊíÆÂΩ±
    runs-on: ubuntu-latest
    steps:
      - name: „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÔºàmain „Éñ„É©„É≥„ÉÅÔºâ
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Node.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: pnpm „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: ‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
        run: pnpm install --frozen-lockfile

      - name: Playwright „ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        working-directory: frontend
        run: |
          if ! grep -q '"playwright"' package.json; then
            pnpm add -D --no-lockfile playwright
          fi
          npx playwright install --with-deps chromium

      - name: Storybook ‰∫íÊèõÊÄß„ÅÆÁ¢∫‰øù
        working-directory: frontend
        run: |
          # @storybook/nextjs „Åå Next.js 16 ÈùûÂØæÂøú„ÅÆÂ†¥Âêà„ÄÅ@storybook/nextjs-vite „Å´ÂàáÊõø
          if grep -q '"@storybook/nextjs"' package.json && ! grep -q '"@storybook/nextjs-vite"' package.json; then
            pnpm add -D --no-lockfile @storybook/nextjs-vite@9.1.17 storybook@9.1.17 vite
            sed -i 's|@storybook/nextjs|@storybook/nextjs-vite|g' .storybook/main.ts
            # „Çπ„Éà„Éº„É™„Éº„Éï„Ç°„Ç§„É´„ÅÆ import „ÇÇÊõ¥Êñ∞
            find src -name "*.stories.tsx" -exec sed -i 's|from "@storybook/nextjs"|from "@storybook/nextjs-vite"|g' {} +
          fi
          # preview.ts „Å´ NextIntlClientProvider „Éá„Ç≥„É¨„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
          if [ -f .storybook/preview.ts ] && ! grep -q 'NextIntlClientProvider' .storybook/preview.ts; then
            mv .storybook/preview.ts .storybook/preview.tsx
            cat > .storybook/preview.tsx << 'PREVIEW'
          import type { Preview } from "@storybook/nextjs-vite";
          import { NextIntlClientProvider } from "next-intl";
          import React from "react";
          import ja from "../src/translations/ja.json";
          const preview: Preview = {
            decorators: [
              (Story) => (
                <NextIntlClientProvider locale="ja" messages={ja}>
                  <Story />
                </NextIntlClientProvider>
              ),
            ],
            parameters: { controls: { matchers: { color: /(background|color)$/i, date: /Date$/i } } },
          };
          export default preview;
          PREVIEW
          fi

      - name: Storybook „ÅÆ„Éì„É´„Éâ
        working-directory: frontend
        run: pnpm build-storybook

      - name: „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊíÆÂΩ±
        working-directory: frontend
        run: |
          python3 -m http.server 6006 --directory storybook-static &
          if [ -f scripts/capture-screenshots.mjs ]; then
            node scripts/capture-screenshots.mjs
          else
            node --input-type=module << 'SCRIPT'
          import { chromium } from "playwright";
          import { mkdirSync } from "node:fs";
          import { join } from "node:path";
          const url = process.env.STORYBOOK_URL || "http://localhost:6006";
          const dir = process.env.SCREENSHOT_DIR || "__screenshots__";
          for (let i = 0; i < 30; i++) {
            try { const r = await fetch(`${url}/index.json`); if (r.ok) break; } catch { /* „Çµ„Éº„Éê„ÉºËµ∑ÂãïÂæÖ„Å° */ }
            if (i === 29) { console.error('„Çµ„Éº„Éê„Éº„ÅåËµ∑Âãï„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü'); process.exit(1); }
            await new Promise(r => setTimeout(r, 1000));
          }
          const res = await fetch(`${url}/index.json`);
          const { entries } = await res.json();
          const stories = Object.entries(entries).filter(([, e]) => e.type === "story");
          mkdirSync(dir, { recursive: true });
          const browser = await chromium.launch();
          const ctx = await browser.newContext({ viewport: { width: 1280, height: 720 } });
          for (const [id] of stories) {
            const page = await ctx.newPage();
            await page.goto(`${url}/iframe.html?id=${id}&viewMode=story`, { waitUntil: "networkidle" });
            await page.waitForTimeout(300);
            await page.screenshot({ path: join(dir, `${id}.png`), fullPage: true });
            await page.close();
            console.log(`‚úì ${id}`);
          }
          await browser.close();
          SCRIPT
          fi
        env:
          STORYBOOK_URL: http://localhost:6006
          SCREENSHOT_DIR: __screenshots__

      - name: „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-expected
          path: frontend/__screenshots__
          retention-days: 30

  compare:
    name: „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊØîËºÉ
    needs: [screenshot-actual, screenshot-expected]
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: actual „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        uses: actions/download-artifact@v4
        with:
          name: screenshots-actual
          path: actual

      - name: expected „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„Éà„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        uses: actions/download-artifact@v4
        with:
          name: screenshots-expected
          path: expected

      - name: Node.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: reg-cli „ÅßÂ∑ÆÂàÜÊØîËºÉ
        id: reg
        run: |
          npx reg-cli actual expected diff \
            --report diff/index.html \
            --json diff/report.json \
            --matchingThreshold 0.01 \
            --enableAntialias
          echo "result=success" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: ÊØîËºÉÁµêÊûú„ÇíÂèñÂæó
        id: summary
        run: |
          if [ -f diff/report.json ]; then
            CHANGED=$(node -e "const r=require('./diff/report.json'); console.log(r.failedItems?.length ?? 0)")
            NEW=$(node -e "const r=require('./diff/report.json'); console.log(r.newItems?.length ?? 0)")
            DELETED=$(node -e "const r=require('./diff/report.json'); console.log(r.deletedItems?.length ?? 0)")
            PASSED=$(node -e "const r=require('./diff/report.json'); console.log(r.passedItems?.length ?? 0)")
            echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"
            echo "new=$NEW" >> "$GITHUB_OUTPUT"
            echo "deleted=$DELETED" >> "$GITHUB_OUTPUT"
            echo "passed=$PASSED" >> "$GITHUB_OUTPUT"
          else
            echo "changed=0" >> "$GITHUB_OUTPUT"
            echo "new=0" >> "$GITHUB_OUTPUT"
            echo "deleted=0" >> "$GITHUB_OUTPUT"
            echo "passed=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Â∑ÆÂàÜ„É¨„Éù„Éº„Éà„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºàArtifactsÔºâ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vrt-report
          path: diff
          retention-days: 30

      - name: GitHub Pages „ÅÆË®≠ÂÆö
        uses: actions/configure-pages@v4

      - name: Â∑ÆÂàÜ„É¨„Éù„Éº„Éà„Çí GitHub Pages „Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        uses: actions/upload-pages-artifact@v3
        with:
          path: diff

      - name: GitHub Pages „Å´„Éá„Éó„É≠„Ç§
        id: deployment
        uses: actions/deploy-pages@v4

      - name: PR „Å´„Ç≥„É°„É≥„Éà
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const changed = '${{ steps.summary.outputs.changed }}';
            const newItems = '${{ steps.summary.outputs.new }}';
            const deleted = '${{ steps.summary.outputs.deleted }}';
            const passed = '${{ steps.summary.outputs.passed }}';
            const hasDiff = Number(changed) > 0 || Number(newItems) > 0 || Number(deleted) > 0;
            const icon = hasDiff ? '‚ö†Ô∏è' : '‚úÖ';
            const reportUrl = '${{ steps.deployment.outputs.page_url }}';

            const body = [
              `## ${icon} Visual Regression Test ÁµêÊûú`,
              '',
              '| È†ÖÁõÆ | ‰ª∂Êï∞ |',
              '|------|------|',
              `| ‚úÖ Â§âÊõ¥„Å™„Åó | ${passed} |`,
              `| üîÑ Â§âÊõ¥„ÅÇ„Çä | ${changed} |`,
              `| üÜï Êñ∞Ë¶è | ${newItems} |`,
              `| üóëÔ∏è ÂâäÈô§ | ${deleted} |`,
              '',
              hasDiff
                ? '> UI „Å´Â∑ÆÂàÜ„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü„ÄÇÊÑèÂõ≥„Åó„ÅüÂ§âÊõ¥„Åã„Å©„ÅÜ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                : '> UI „Å´Â∑ÆÂàÜ„ÅØÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ',
              '',
              reportUrl
                ? `üìä **[VRT „É¨„Éù„Éº„Éà„ÇíÁ¢∫Ë™ç„Åô„Çã](${reportUrl})**`
                : 'üìé Ë©≥Á¥∞„Å™Â∑ÆÂàÜ„É¨„Éù„Éº„Éà„ÅØ Actions „ÅÆ Artifacts (`vrt-report`) „Åã„Çâ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô„ÄÇ',
            ].join('\n');

            // Êó¢Â≠ò„ÅÆVRT„Ç≥„É°„É≥„Éà„ÇíÊé¢„Åó„Å¶Êõ¥Êñ∞„ÄÅ„Å™„Åë„Çå„Å∞Êñ∞Ë¶è‰ΩúÊàê
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.body?.includes('Visual Regression Test ÁµêÊûú')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
