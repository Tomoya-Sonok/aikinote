name: Visual Regression Test

on:
  pull_request:
    branches: [main]
    paths:
      - "frontend/**"
      - ".github/workflows/vrt.yml"

permissions:
  contents: read
  pull-requests: write
  pages: write
  id-token: write

jobs:
  screenshot-actual:
    name: PR ãƒ–ãƒ©ãƒ³ãƒã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆPR ãƒ–ãƒ©ãƒ³ãƒï¼‰
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install --frozen-lockfile

      - name: Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Storybook ã®ãƒ“ãƒ«ãƒ‰
        working-directory: frontend
        run: pnpm build-storybook

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±
        working-directory: frontend
        run: |
          python3 -m http.server 6006 --directory storybook-static &
          node scripts/capture-screenshots.mjs
        env:
          STORYBOOK_URL: http://localhost:6006
          SCREENSHOT_DIR: __screenshots__

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-actual
          path: frontend/__screenshots__
          retention-days: 30

  screenshot-expected:
    name: main ãƒ–ãƒ©ãƒ³ãƒã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒï¼‰
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install --frozen-lockfile

      - name: Playwright ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        working-directory: frontend
        run: |
          if ! grep -q '"playwright"' package.json; then
            pnpm add -D --no-lockfile playwright
          fi
          npx playwright install --with-deps chromium

      - name: Storybook äº’æ›æ€§ã®ç¢ºä¿
        working-directory: frontend
        run: |
          # @storybook/nextjs ãŒ Next.js 16 éå¯¾å¿œã®å ´åˆã€@storybook/nextjs-vite ã«åˆ‡æ›¿
          if grep -q '"@storybook/nextjs"' package.json && ! grep -q '"@storybook/nextjs-vite"' package.json; then
            pnpm add -D --no-lockfile @storybook/nextjs-vite@9.1.17 storybook@9.1.17 vite
            sed -i 's|@storybook/nextjs|@storybook/nextjs-vite|g' .storybook/main.ts
            # ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã® import ã‚‚æ›´æ–°
            find src -name "*.stories.tsx" -exec sed -i 's|from "@storybook/nextjs"|from "@storybook/nextjs-vite"|g' {} +
          fi
          # preview.ts ã« NextIntlClientProvider ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯è¿½åŠ 
          if [ -f .storybook/preview.ts ] && ! grep -q 'NextIntlClientProvider' .storybook/preview.ts; then
            mv .storybook/preview.ts .storybook/preview.tsx
            cat > .storybook/preview.tsx << 'PREVIEW'
import type { Preview } from "@storybook/nextjs-vite";
import { NextIntlClientProvider } from "next-intl";
import React from "react";
import ja from "../src/translations/ja.json";

const preview: Preview = {
  decorators: [
    (Story) => (
      <NextIntlClientProvider locale="ja" messages={ja}>
        <Story />
      </NextIntlClientProvider>
    ),
  ],
  parameters: {
    controls: {
      matchers: { color: /(background|color)$/i, date: /Date$/i },
    },
  },
};

export default preview;
PREVIEW
          fi

      - name: Storybook ã®ãƒ“ãƒ«ãƒ‰
        working-directory: frontend
        run: pnpm build-storybook

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±
        working-directory: frontend
        run: |
          python3 -m http.server 6006 --directory storybook-static &
          if [ -f scripts/capture-screenshots.mjs ]; then
            node scripts/capture-screenshots.mjs
          else
            node --input-type=module << 'SCRIPT'
          import { chromium } from "playwright";
          import { mkdirSync } from "node:fs";
          import { join } from "node:path";
          const url = process.env.STORYBOOK_URL || "http://localhost:6006";
          const dir = process.env.SCREENSHOT_DIR || "__screenshots__";
          for (let i = 0; i < 30; i++) {
            try { const r = await fetch(`${url}/index.json`); if (r.ok) break; } catch { /* ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾…ã¡ */ }
            if (i === 29) { console.error('ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã›ã‚“ã§ã—ãŸ'); process.exit(1); }
            await new Promise(r => setTimeout(r, 1000));
          }
          const res = await fetch(`${url}/index.json`);
          const { entries } = await res.json();
          const stories = Object.entries(entries).filter(([, e]) => e.type === "story");
          mkdirSync(dir, { recursive: true });
          const browser = await chromium.launch();
          const ctx = await browser.newContext({ viewport: { width: 1280, height: 720 } });
          for (const [id] of stories) {
            const page = await ctx.newPage();
            await page.goto(`${url}/iframe.html?id=${id}&viewMode=story`, { waitUntil: "networkidle" });
            await page.waitForTimeout(300);
            await page.screenshot({ path: join(dir, `${id}.png`), fullPage: true });
            await page.close();
            console.log(`âœ“ ${id}`);
          }
          await browser.close();
          SCRIPT
          fi
        env:
          STORYBOOK_URL: http://localhost:6006
          SCREENSHOT_DIR: __screenshots__

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-expected
          path: frontend/__screenshots__
          retention-days: 30

  compare:
    name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ¯”è¼ƒ
    needs: [screenshot-actual, screenshot-expected]
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: actual ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: screenshots-actual
          path: actual

      - name: expected ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: screenshots-expected
          path: expected

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: reg-cli ã§å·®åˆ†æ¯”è¼ƒ
        id: reg
        run: |
          npx reg-cli actual expected diff \
            --report diff/index.html \
            --json diff/report.json \
            --matchingThreshold 0.01 \
            --enableAntialias
          echo "result=success" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: æ¯”è¼ƒçµæœã‚’å–å¾—
        id: summary
        run: |
          if [ -f diff/report.json ]; then
            CHANGED=$(node -e "const r=require('./diff/report.json'); console.log(r.failedItems?.length ?? 0)")
            NEW=$(node -e "const r=require('./diff/report.json'); console.log(r.newItems?.length ?? 0)")
            DELETED=$(node -e "const r=require('./diff/report.json'); console.log(r.deletedItems?.length ?? 0)")
            PASSED=$(node -e "const r=require('./diff/report.json'); console.log(r.passedItems?.length ?? 0)")
            echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"
            echo "new=$NEW" >> "$GITHUB_OUTPUT"
            echo "deleted=$DELETED" >> "$GITHUB_OUTPUT"
            echo "passed=$PASSED" >> "$GITHUB_OUTPUT"
          else
            echo "changed=0" >> "$GITHUB_OUTPUT"
            echo "new=0" >> "$GITHUB_OUTPUT"
            echo "deleted=0" >> "$GITHUB_OUTPUT"
            echo "passed=0" >> "$GITHUB_OUTPUT"
          fi

      - name: å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆArtifactsï¼‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vrt-report
          path: diff
          retention-days: 30

      - name: GitHub Pages ã®è¨­å®š
        uses: actions/configure-pages@v4

      - name: å·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã‚’ GitHub Pages ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: diff

      - name: GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deployment
        uses: actions/deploy-pages@v4

      - name: PR ã«ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const changed = '${{ steps.summary.outputs.changed }}';
            const newItems = '${{ steps.summary.outputs.new }}';
            const deleted = '${{ steps.summary.outputs.deleted }}';
            const passed = '${{ steps.summary.outputs.passed }}';
            const hasDiff = Number(changed) > 0 || Number(newItems) > 0 || Number(deleted) > 0;
            const icon = hasDiff ? 'âš ï¸' : 'âœ…';
            const reportUrl = '${{ steps.deployment.outputs.page_url }}';

            const body = [
              `## ${icon} Visual Regression Test çµæœ`,
              '',
              '| é …ç›® | ä»¶æ•° |',
              '|------|------|',
              `| âœ… å¤‰æ›´ãªã— | ${passed} |`,
              `| ğŸ”„ å¤‰æ›´ã‚ã‚Š | ${changed} |`,
              `| ğŸ†• æ–°è¦ | ${newItems} |`,
              `| ğŸ—‘ï¸ å‰Šé™¤ | ${deleted} |`,
              '',
              hasDiff
                ? '> UI ã«å·®åˆ†ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ„å›³ã—ãŸå¤‰æ›´ã‹ã©ã†ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
                : '> UI ã«å·®åˆ†ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚',
              '',
              reportUrl && reportUrl !== ''
                ? `ğŸ“Š **[VRT ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã™ã‚‹](${reportUrl})**`
                : 'ğŸ“ è©³ç´°ãªå·®åˆ†ãƒ¬ãƒãƒ¼ãƒˆã¯ Actions ã® Artifacts (`vrt-report`) ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚',
            ].join('\n');

            // æ—¢å­˜ã®VRTã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã—ã¦æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.body?.includes('Visual Regression Test çµæœ')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
